(function() {
  const audio = document.getElementById('audioPlayer');
  const playBtn = document.getElementById('playBtn');
  const revealBtn = document.getElementById('revealBtn');
  const nextBtn = document.getElementById('nextBtn');
  const songInfo = document.getElementById('songInfo');
  
  const infoArtist = document.getElementById('infoArtist');
  const infoTitle = document.getElementById('infoTitle');
  const infoAlbum = document.getElementById('infoAlbum');
  const infoYear = document.getElementById('infoYear');
  const infoCover = document.getElementById('infoCover');

  const TRANSLATIONS = {{ texts|tojson }};
  const EMOJI = {{ emoji|tojson }};

  let currentSong = null;
  let songs = [];

  function getMp3NameFromUrl() {
    const path = window.location.pathname;
    // Handle both /filename.mp3 and /path/to/filename.mp3
    const filename = path.split('/').pop();
    if (filename.endsWith('.mp3')) {
      return filename;
    }
    return null;
  }

  function setBtnState(isPlaying) {
    if (isPlaying) {
      playBtn.classList.add('playing');
      playBtn.classList.remove('paused');
      playBtn.innerHTML = `<span class='icon'>${EMOJI}</span> ${TRANSLATIONS['button_pause']}`;
    } else {
      playBtn.classList.remove('playing');
      playBtn.classList.add('paused');
      playBtn.innerHTML = `<span class='icon'>${EMOJI}</span> ${TRANSLATIONS['button_play']}`;
    }
  }

  async function loadRandomSong(autoPlay = false) {
    try {
      if (songs.length === 0) {
        const response = await fetch('index.json');
        songs = await response.json();
      }
      
      if (songs.length === 0) {
        playBtn.textContent = TRANSLATIONS['no_song_detected'];
        return;
      }

      // Reset UI for new song
      audio.pause();
      audio.currentTime = 0;
      setBtnState(false);
      songInfo.style.display = 'none';
      revealBtn.style.display = 'block';

      const randomIndex = Math.floor(Math.random() * songs.length);
      currentSong = songs[randomIndex];
      
      audio.src = `${currentSong.url_mp3}`;
      revealBtn.disabled = false;
      
      // Pre-fill info but keep hidden
      infoArtist.textContent = currentSong.artist;
      infoTitle.textContent = currentSong.title;
      infoAlbum.textContent = currentSong.album || '';
      infoYear.textContent = currentSong.year;
      infoCover.src = currentSong.cover || '';

      if (autoPlay) {
        audio.play().catch(e => console.log("Auto-play blocked:", e));
        setBtnState(true);
      }
    } catch (e) {
      console.error("Error loading songs:", e);
      playBtn.textContent = "Error loading index.json";
    }
  }

  const mp3 = getMp3NameFromUrl();

  if (mp3) {
    // QR MODE: Just play the specific song
    audio.src = `songs/${mp3}`;
    
    // Hide game UI elements in QR mode
    revealBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    songInfo.style.display = 'none';
    
    playBtn.addEventListener('click', function() {
      if (audio.paused) {
        audio.play();
        setBtnState(true);
      } else {
        audio.pause();
        setBtnState(false);
      }
    });

    // Touch any to start for mobile
    document.body.addEventListener('touchstart', () => {
        if (audio.paused) audio.play();
    }, { once: true });

    // Attempt autoplay
    setTimeout(() => {
      audio.play().catch(() => setBtnState(false));
    }, 100);

  } else {
    // SINGLE PLAYER MODE: Random songs + reveal + next
    revealBtn.style.display = 'flex';
    nextBtn.style.display = 'flex';

    playBtn.addEventListener('click', function() {
      if (!audio.src) return;
      if (audio.paused) {
        audio.play();
        setBtnState(true);
      } else {
        audio.pause();
        setBtnState(false);
      }
    });

    revealBtn.addEventListener('click', function() {
      songInfo.style.display = 'block';
      revealBtn.style.display = 'none';
    });

    nextBtn.addEventListener('click', function() {
      loadRandomSong(true);
    });

    loadRandomSong(false);
  }

  // Common listeners
  audio.addEventListener('play', () => setBtnState(true));
  audio.addEventListener('pause', () => setBtnState(false));
  audio.addEventListener('ended', () => setBtnState(false));

})();
